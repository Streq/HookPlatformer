<html>

<head>
	<script src="collision.js"></script>
	<script src="game.js"></script>
	<script src="setup.js"></script>
</head>

<body>
	<canvas id="canvas" width=1000 height=1000 style="background-color:black"></canvas>

	<script src="testingRendering.js"></script>
	<script src="gridCollisionWorld.js"></script>
	<script>
		let x0 = 0,
			y0 = 0,
			x1 = 10,
			y1 = 10,
			w = 0.75,
			h = 0.75,
			cx = 0,
			cy = 0,
			blocks = [
				[2, 9],
				[2, 11],

				[14, 10],
				[15, 10],
				[16, 10],
				[17, 10],
				[18, 10],
				[19, 10],
				[20, 10],
				[17, 7],
				[17, 8],
				[17, 9],
				[17, 11],
				[17, 12],
				[17, 13],

				[4, 10],
				[5, 10],
				[6, 10],
				[8, 10],
				[9, 10],
				[10, 10],
				[7, 7],
				[7, 8],
				[7, 9],
				[7, 11],
				[7, 12],
				[7, 13],
			],
			world = new GridCollisionWorld(),
			grid = world.grid,
			collisions = [],
			touched = [],
			mousedown = false;
		
		blocks.forEach((e)=>{
			grid.set(e[0]  ,e[1],1);
			grid.set(e[0]+5,e[1]+2,1);
			grid.set(e[0]  ,e[1]+2,1);
			grid.set(e[0]-5,e[1]-2,1);
		});


		function render() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			grid.forEach((e,x,y) => {
				ctx.fillStyle = "blue";
				if(!e)return;
				ctx.fillRect(x * gs, y * gs, gs, gs);
			});
			touched.forEach((e) => {
				ctx.fillStyle = "red";
				ctx.fillRect(e[0] * gs, e[1] * gs, gs, gs);
			})
			let i = 0;
			collisions.forEach((e) => {
				drawTile(e[0], e[1], ++i);
			});

			drawMovingBlock(x0, y0, x1, y1);
			touched = [];
			collisions = [];
		}
		
		function check(x,y){
			let g = grid.get(x,y);
			return g && [x,y];
		}
		
		function step(x_, y_) {
			let collisions_ = [];
			let touched_ = [];

			let dx = x_ - x1;
			let dy = y_ - y1;
			let m = dy / dx;
			let n = dx / dy;

			let obj = {x:x1,y:y1,w:w,h:h,vx:dx,vy:dy};
			world.objects = [obj];
			world.step(1);
			
			x0=x1;
			y0=y1;
			x1=obj.x;
			y1=obj.y;
			
			collisions = collisions_.concat(collisions);
			touched = touched_.concat(touched)
		}
		


		render();


		const dothething = (e) => {
			let pos = getMousePos(canvas, e);

			step(pos.x / gs, pos.y / gs);
			render();
		};
		document.body.addEventListener("mousemove", dothething);
		var movermouse = true;
		document.body.addEventListener("keypress", () => {
			if (movermouse=!movermouse) {
				document.body.removeEventListener("mousemove", dothething);
				document.body.addEventListener("click", dothething);
			} else {
				document.body.removeEventListener("click", dothething);
				document.body.addEventListener("mousemove", dothething);
			}
		});
	</script>
</body>

</html>